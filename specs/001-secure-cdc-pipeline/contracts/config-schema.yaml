# Pipeline Configuration Schema
# This schema defines the structure for config/pipeline.yaml
# Validates using pydantic-settings in src/config/settings.py

cassandra:
  description: "Cassandra source database configuration"
  type: object
  required:
    - hosts
    - keyspace
    - cdc_raw_directory
  properties:
    hosts:
      type: array
      items:
        type: string
        format: hostname-or-ip
      minItems: 1
      description: "List of Cassandra contact points (hostnames or IPs)"
      example: ["cassandra-1.example.com", "cassandra-2.example.com"]
    port:
      type: integer
      minimum: 1
      maximum: 65535
      default: 9042
      description: "Cassandra native protocol port"
    keyspace:
      type: string
      pattern: "^[a-z_][a-z0-9_]*$"
      description: "Cassandra keyspace to monitor for CDC events"
      example: "production"
    username:
      type: string
      description: "Cassandra username (from environment variable CDC_CASSANDRA_USERNAME)"
    password:
      type: string
      format: password
      description: "Cassandra password (from environment variable CDC_CASSANDRA_PASSWORD)"
    cdc_raw_directory:
      type: string
      format: path
      description: "Path to Cassandra CDC commitlog directory"
      example: "/var/lib/cassandra/cdc_raw"
    ssl_enabled:
      type: boolean
      default: true
      description: "Enable TLS 1.3+ for Cassandra connections"
    ssl_ca_cert:
      type: string
      format: path
      description: "Path to CA certificate for TLS verification"

destinations:
  description: "Data warehouse destination configurations"
  type: object
  required:
    - postgres
    - clickhouse
    - timescaledb
  properties:
    postgres:
      type: object
      required: [host, port, database]
      properties:
        host:
          type: string
          format: hostname
        port:
          type: integer
          default: 5432
        database:
          type: string
        username:
          type: string
          description: "From CDC_POSTGRES_USERNAME env var"
        password:
          type: string
          format: password
          description: "From CDC_POSTGRES_PASSWORD env var"
        ssl_mode:
          type: string
          enum: [disable, require, verify-ca, verify-full]
          default: require
        connection_pool_size:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
    clickhouse:
      type: object
      required: [host, port, database]
      properties:
        host:
          type: string
          format: hostname
        port:
          type: integer
          default: 9000
        database:
          type: string
        username:
          type: string
          description: "From CDC_CLICKHOUSE_USERNAME env var"
        password:
          type: string
          format: password
          description: "From CDC_CLICKHOUSE_PASSWORD env var"
        use_tls:
          type: boolean
          default: true
        connection_pool_size:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
    timescaledb:
      type: object
      required: [host, port, database]
      properties:
        host:
          type: string
          format: hostname
        port:
          type: integer
          default: 5432
        database:
          type: string
        username:
          type: string
          description: "From CDC_TIMESCALEDB_USERNAME env var"
        password:
          type: string
          format: password
          description: "From CDC_TIMESCALEDB_PASSWORD env var"
        ssl_mode:
          type: string
          enum: [disable, require, verify-ca, verify-full]
          default: require
        connection_pool_size:
          type: integer
          minimum: 1
          maximum: 100
          default: 10

pipeline:
  description: "Core pipeline tuning parameters"
  type: object
  properties:
    batch_size:
      type: integer
      minimum: 1
      maximum: 10000
      default: 100
      description: "Number of events per micro-batch"
    max_parallelism:
      type: integer
      minimum: 1
      maximum: 64
      default: 4
      description: "Concurrent workers per Cassandra partition"
    max_in_flight_batches:
      type: integer
      minimum: 1
      maximum: 1000
      default: 10
      description: "Maximum uncommitted batches (backpressure control)"
    poll_interval_ms:
      type: integer
      minimum: 10
      maximum: 60000
      default: 100
      description: "Commitlog polling interval in milliseconds"

retry:
  description: "Retry and failure handling configuration"
  type: object
  properties:
    max_attempts:
      type: integer
      minimum: 1
      maximum: 100
      default: 5
      description: "Maximum retry attempts before DLQ"
    base_delay_ms:
      type: integer
      minimum: 10
      maximum: 10000
      default: 100
      description: "Initial retry delay in milliseconds"
    max_delay_ms:
      type: integer
      minimum: 100
      maximum: 300000
      default: 30000
      description: "Maximum retry delay (cap for exponential backoff)"
    backoff_multiplier:
      type: number
      minimum: 1.0
      maximum: 10.0
      default: 2.0
      description: "Exponential backoff multiplier"
    jitter:
      type: boolean
      default: true
      description: "Add random jitter (0-25%) to retry delays"

observability:
  description: "Metrics, logging, and tracing configuration"
  type: object
  properties:
    metrics_port:
      type: integer
      minimum: 1024
      maximum: 65535
      default: 9090
      description: "Prometheus metrics HTTP endpoint port"
    metrics_path:
      type: string
      pattern: "^/.*$"
      default: "/metrics"
      description: "Prometheus metrics URL path"
    health_check_port:
      type: integer
      minimum: 1024
      maximum: 65535
      default: 8080
      description: "Health check HTTP endpoint port"
    health_check_path:
      type: string
      pattern: "^/.*$"
      default: "/health"
      description: "Health check URL path"
    log_level:
      type: string
      enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
      default: INFO
      description: "Logging severity level"
    log_format:
      type: string
      enum: [json, console]
      default: json
      description: "Log output format (json for production, console for dev)"
    enable_tracing:
      type: boolean
      default: false
      description: "Enable OpenTelemetry distributed tracing (optional)"
    tracing_endpoint:
      type: string
      format: uri
      description: "OpenTelemetry collector endpoint (e.g., http://jaeger:4318)"

# Example complete configuration
example:
  cassandra:
    hosts: ["localhost"]
    port: 9042
    keyspace: "production"
    cdc_raw_directory: "/var/lib/cassandra/cdc_raw"
    ssl_enabled: true
  destinations:
    postgres:
      host: "localhost"
      port: 5432
      database: "warehouse"
      ssl_mode: "require"
      connection_pool_size: 10
    clickhouse:
      host: "localhost"
      port: 9000
      database: "warehouse"
      use_tls: true
      connection_pool_size: 10
    timescaledb:
      host: "localhost"
      port: 5433
      database: "warehouse"
      ssl_mode: "require"
      connection_pool_size: 10
  pipeline:
    batch_size: 100
    max_parallelism: 4
    max_in_flight_batches: 10
    poll_interval_ms: 100
  retry:
    max_attempts: 5
    base_delay_ms: 100
    max_delay_ms: 30000
    backoff_multiplier: 2.0
    jitter: true
  observability:
    metrics_port: 9090
    metrics_path: "/metrics"
    health_check_port: 8080
    health_check_path: "/health"
    log_level: "INFO"
    log_format: "json"
    enable_tracing: false
